name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest    
    steps:
          # Your workflow steps here

          - name: Checkout Repository
            uses: actions/checkout@v2
          
          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v1
          
          - name: Build Frontend Docker Image
            run: docker build -t ${{ secrets.DOCKER_USERNAME }}/mearn-stack_frontend mern-docker/frontend
          
          - name: Build Backend Docker Image
            run: docker build -t ${{ secrets.DOCKER_USERNAME }}/mearn-stack_backend mern-docker/backend
          
          - name: Login to Docker Hub
            uses: docker/login-action@v1
            with:
              username: ${{ secrets.DOCKER_USERNAME }}
              password: ${{ secrets.DOCKER_PASSWORD }}
          
          - name: Push Frontend Docker Image
            run: docker push stt96/mearn-stack_frontend
          
          - name: Push Backend Docker Image
            run: docker push stt96/mearn-stack_backend

  # deploy:
  #   runs-on: ubuntu-latest
  #   needs: build
  #   steps:
          # Your workflow steps here

          # - name: Checkout Repository
          #   uses: actions/checkout@v2
          
          # - name: Set up Docker Buildx
          #   uses: docker/setup-buildx-action@v1
          
          - name: Login to Docker Hub
            uses: docker/login-action@v1
            with:
              username: ${{ secrets.DOCKER_USERNAME }}
              password: ${{ secrets.DOCKER_PASSWORD }}
          
          - name: Pull Frontend Docker Image
            run: sudo docker pull stt96/mearn-stack_frontend:latest
          
          - name: Pull Backend Docker Image
            run: sudo docker pull stt96/mearn-stack_backend:latest

          # - name: Delete Old Backend Docker Image
          #   run: docker pull mearn-stack_backend-container

          # - name: Delete Old Frontend Docker Image
          #   run: docker rm -f mearn-stack_frontend-container  
          
          - name: Deploy Frontend Docker Image
            run: sudo docker run -d -p 3000:3000 stt96/mearn-stack_frontend:latest
          
          - name: Deploy Backend Docker Image
            run: sudo docker run -d -p 5000:5000 stt96/mearn-stack_backend:latest
        