name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest    
    steps:
          # Your workflow steps here

          - name: Checkout Repository
            uses: actions/checkout@v2
          
          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v1
          
          - name: Build Frontend Docker Image
            run: docker build -t ${{ secrets.DOCKER_USERNAME }}/mearn-stack_frontend mern-docker/frontend
          
          - name: Build Backend Docker Image
            run: docker build -t ${{ secrets.DOCKER_USERNAME }}/mearn-stack_backend mern-docker/backend
          
          - name: Login to Docker Hub
            uses: docker/login-action@v1
            with:
              username: ${{ secrets.DOCKER_USERNAME }}
              password: ${{ secrets.DOCKER_PASSWORD }}
          
          - name: Push Frontend Docker Image
            run: docker push stt96/mearn-stack_frontend:latest
          
          - name: Push Backend Docker Image
            run: docker push stt96/mearn-stack_backend:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:

          - name: SSH into Server instance and deploy
            uses: appleboy/ssh-action@master
            with:
                host: ${{ secrets.SERVER_HOST }}
                username: ${{ secrets.SERVER_USERNAME }}
                key: ${{ secrets.SSH_PRIVATE_KEY }}
                
                # script: |
                #   sudo docker pull ${{ secrets.DOCKER_USERNAME }}/blog-application:client-${{github.run_number}}
                #   sudo docker pull ${{ secrets.DOCKER_USERNAME }}/blog-application:api-${{github.run_number}}
                #   sudo docker stop my-node-app || true
                #   sudo docker rm my-node-app || true
                #   sudo docker stop my-node-app-api || true
                #   sudo docker rm my-node-app-api || true
                #   sudo docker run -d -p 5000:5000 stt96/mearn-stack_backend:latest
                #   docker run -d -p 3000:3000 stt96/mearn-stack_frontend:latest
                #   sudo docker run -d -p 3000:3000 --name my-node-app-api ${{ secrets.DOCKER_USERNAME }}/blog-application:api-${{github.run_number}}
          
          - name: Pull Frontend Docker Image
            run: sudo docker pull stt96/mearn-stack_frontend:latest
          
          - name: Pull Backend Docker Image
            run: sudo docker pull stt96/mearn-stack_backend:latest

          - name: Delete Old Backend Docker Image
            run: docker pull mearn-stack_backend-container

          - name: Delete Old Frontend Docker Image
            run: docker rm -f mearn-stack_frontend-container  
          
          - name: Deploy Frontend Docker Image
            run: sudo docker run -d -p 3000:3000 stt96/mearn-stack_frontend:latest
          
          - name: Deploy Backend Docker Image
            run: sudo docker run -d -p 5000:5000 stt96/mearn-stack_backend:latest

          # Your workflow steps here

          # - name: Checkout Repository
          #   uses: actions/checkout@v2
          
          # - name: Set up Docker Buildx
          #   uses: docker/setup-buildx-action@v1
          
          # - name: Login to Docker Hub
          #   uses: docker/login-action@v1
          #   with:
          #     username: ${{ secrets.DOCKER_USERNAME }}
          #     password: ${{ secrets.DOCKER_PASSWORD }}
          
          # - name: Pull Frontend Docker Image
          #   run: sudo docker pull stt96/mearn-stack_frontend:latest
          
          # - name: Pull Backend Docker Image
          #   run: sudo docker pull stt96/mearn-stack_backend:latest

          # # - name: Delete Old Backend Docker Image
          # #   run: docker pull mearn-stack_backend-container

          # # - name: Delete Old Frontend Docker Image
          # #   run: docker rm -f mearn-stack_frontend-container  
          
          # - name: Deploy Frontend Docker Image
          #   run: sudo docker run -d -p 3000:3000 stt96/mearn-stack_frontend:latest
          
          # - name: Deploy Backend Docker Image
          #   run: sudo docker run -d -p 5000:5000 stt96/mearn-stack_backend:latest
        # key: ${{ secrets.SSH_PRIVATE_KEY }}